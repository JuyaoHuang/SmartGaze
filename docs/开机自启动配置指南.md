# 开机自启动配置指南

本文档介绍如何配置智能门禁系统在 RK3568 开发板上电后自动启动。

## 方案概述

使用 **systemd** 服务管理器实现开机自启动，具有以下优点：
- ✅ 开机自动启动
- ✅ 服务崩溃自动重启
- ✅ 标准的 Linux 服务管理
- ✅ 易于启动、停止、查看状态

## 前置要求

1. **已完成系统部署**：项目文件位于 `/home/topeet/face_detection_system`
2. **Conda 环境已配置**：环境名称为 `rknn`
3. **服务可手动启动**：确认 `python -m backend.main` 能正常运行
4. **用户权限**：需要 sudo 权限安装系统服务

## 安装步骤

### 步骤1：上传脚本到开发板

将以下文件上传到开发板的项目目录：
```
/home/topeet/face_detection_system/scripts/
├── start_service.sh          # 启动脚本
├── stop_service.sh           # 停止脚本
└── face-detection.service    # systemd 服务配置
```

使用 scp 上传：
```bash
# 在本地执行（从项目根目录）
scp scripts/* topeet@192.168.50.1:/home/topeet/face_detection_system/scripts/
```

### 步骤2：添加执行权限

在开发板上执行：
```bash
cd /home/topeet/face_detection_system
chmod +x scripts/start_service.sh
chmod +x scripts/stop_service.sh
```

### 步骤3：测试启动脚本

**手动测试启动**：
```bash
bash scripts/start_service.sh
```

应该看到：
```
==========================================
智能门禁系统启动成功！
==========================================
服务地址: http://192.168.50.1:8000
日志文件: /home/topeet/face_detection_system/logs/service.log
PID 文件: /home/topeet/face_detection_system/service.pid
```

**测试停止**：
```bash
bash scripts/stop_service.sh
```

应该看到：
```
✓ 服务已停止
```

### 步骤4：安装 systemd 服务

```bash
# 1. 复制服务文件到 systemd 目录
sudo cp scripts/face-detection.service /etc/systemd/system/

# 2. 重载 systemd 配置
sudo systemctl daemon-reload

# 3. 启用开机自启动
sudo systemctl enable face-detection.service

# 4. 启动服务
sudo systemctl start face-detection.service

# 5. 查看服务状态
sudo systemctl status face-detection.service
```

**成功状态示例**：
```
● face-detection.service - 智能门禁系统服务 (Smart Face Detection System)
   Loaded: loaded (/etc/systemd/system/face-detection.service; enabled; vendor preset: enabled)
   Active: active (running) since Wed 2025-12-25 10:30:00 CST; 5s ago
  Process: 1234 ExecStart=/bin/bash /home/topeet/face_detection_system/scripts/start_service.sh (code=exited, status=0/SUCCESS)
 Main PID: 1235 (python)
    Tasks: 5 (limit: 4915)
   CGroup: /system.slice/face-detection.service
           └─1235 python -m backend.main
```

### 步骤5：验证开机自启动

**重启开发板验证**：
```bash
sudo reboot
```

重启后，等待约 30 秒，检查服务状态：
```bash
sudo systemctl status face-detection.service
```

如果显示 `Active: active (running)`，说明开机自启动配置成功。

访问 Web 界面验证：
```
http://192.168.50.1:8000
```

## 服务管理命令

### 启动服务
```bash
sudo systemctl start face-detection.service
```

### 停止服务
```bash
sudo systemctl stop face-detection.service
```

### 重启服务
```bash
sudo systemctl restart face-detection.service
```

### 查看服务状态
```bash
sudo systemctl status face-detection.service
```

### 查看实时日志
```bash
# 方法1：查看 systemd 日志
sudo journalctl -u face-detection.service -f

# 方法2：查看应用日志
tail -f /home/topeet/face_detection_system/logs/service.log
```

### 禁用开机自启动
```bash
sudo systemctl disable face-detection.service
```

### 重新启用开机自启动
```bash
sudo systemctl enable face-detection.service
```

## 日志文件位置

系统会自动创建以下日志文件：

| 文件路径 | 说明 |
|---------|------|
| `logs/service.log` | 应用主日志（包含人脸识别、开门等日志） |
| `logs/systemd.log` | systemd 标准输出日志 |
| `logs/systemd-error.log` | systemd 错误日志 |

**查看日志**：
```bash
# 查看最近 100 行日志
tail -n 100 logs/service.log

# 实时查看日志
tail -f logs/service.log

# 查看所有日志
cat logs/service.log
```

## 故障排查

### 问题1：服务启动失败

**检查方法**：
```bash
# 1. 查看服务状态
sudo systemctl status face-detection.service

# 2. 查看详细日志
sudo journalctl -u face-detection.service -n 50

# 3. 查看应用日志
tail -n 50 logs/service.log
```

**常见原因**：
- Conda 环境名称错误（检查 `start_service.sh` 中的 `CONDA_ENV`）
- 项目路径错误（检查 `start_service.sh` 中的 `PROJECT_DIR`）
- 权限不足（确保脚本有执行权限）
- 依赖缺失（检查 conda 环境是否完整）

### 问题2：服务启动后自动停止

**检查方法**：
```bash
# 查看崩溃日志
sudo journalctl -u face-detection.service --since "10 minutes ago"
```

**可能原因**：
- Python 代码错误（检查 `logs/service.log`）
- 摄像头无法访问（检查摄像头是否连接）
- 数据库文件损坏（检查 `backend/database/database.db`）

### 问题3：无法访问 Web 界面

**检查方法**：
```bash
# 1. 确认服务运行中
sudo systemctl status face-detection.service

# 2. 检查端口是否监听
netstat -tuln | grep 8000

# 3. 检查防火墙
sudo iptables -L -n | grep 8000
```

**解决方法**：
- 确认服务状态为 `active (running)`
- 确认 8000 端口已监听
- 检查开发板 IP 地址：`ip addr show`

### 问题4：开机自启动不生效

**检查方法**：
```bash
# 检查服务是否启用
sudo systemctl is-enabled face-detection.service
```

**解决方法**：
```bash
# 如果显示 disabled，重新启用
sudo systemctl enable face-detection.service

# 查看启动失败原因
sudo journalctl -b | grep face-detection
```

## 高级配置

### 修改启动参数

编辑 `scripts/start_service.sh`，修改配置项：
```bash
# 项目路径
PROJECT_DIR="/home/topeet/face_detection_system"

# Conda 环境名称
CONDA_ENV="rknn"

# Conda 安装路径
CONDA_PATH="/home/topeet/miniconda3"
```

修改后需要重启服务：
```bash
sudo systemctl daemon-reload
sudo systemctl restart face-detection.service
```

### 调整重启策略

编辑 `/etc/systemd/system/face-detection.service`：
```ini
[Service]
# 重启策略：
# - no: 不重启（默认）
# - on-failure: 仅在失败时重启
# - always: 总是重启
Restart=on-failure

# 重启间隔（秒）
RestartSec=10
```

修改后重载配置：
```bash
sudo systemctl daemon-reload
sudo systemctl restart face-detection.service
```

### 设置资源限制

编辑服务文件，添加资源限制：
```ini
[Service]
# 限制内存使用（1GB）
MemoryLimit=1G

# 限制 CPU 使用（50%）
CPUQuota=50%
```

## 卸载服务

如果需要移除开机自启动：

```bash
# 1. 停止服务
sudo systemctl stop face-detection.service

# 2. 禁用自启动
sudo systemctl disable face-detection.service

# 3. 删除服务文件
sudo rm /etc/systemd/system/face-detection.service

# 4. 重载 systemd
sudo systemctl daemon-reload
```

## 附录：手动管理服务（不使用 systemd）

如果不想使用 systemd，可以手动管理：

### 启动服务
```bash
cd /home/topeet/face_detection_system
bash scripts/start_service.sh
```

### 停止服务
```bash
cd /home/topeet/face_detection_system
bash scripts/stop_service.sh
```

### 查看服务状态
```bash
# 检查进程是否运行
ps aux | grep "python -m backend.main"

# 查看 PID
cat /home/topeet/face_detection_system/service.pid
```

### 开机自启动（rc.local 方式）

编辑 `/etc/rc.local`（如果存在）：
```bash
#!/bin/bash
# 添加以下内容
/bin/bash /home/topeet/face_detection_system/scripts/start_service.sh

exit 0
```

添加执行权限：
```bash
sudo chmod +x /etc/rc.local
```

## 总结

按照本文档完成配置后：
- ✅ 开发板上电后自动启动智能门禁系统
- ✅ 服务崩溃自动重启（10 秒后）
- ✅ 可通过 systemd 命令管理服务
- ✅ 日志文件自动记录运行状态

如有问题，请查看日志文件或联系技术支持。
